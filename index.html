<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pablo Mora Moreno | Engineer Portfolio</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* --- PALETA DE COLORES (Dark Engineering Theme) --- */
            --bg-body: #0f1115;       /* Fondo General */
            --bg-sidebar: #161b22;    /* Barra Lateral */
            --bg-card: #1c2128;       /* Tarjetas de contenido */
            --border: #30363d;        /* Bordes sutiles */
            --accent: #2f81f7;        /* Azul eléctrico */
            --accent-dim: rgba(47, 129, 247, 0.15);
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --code-text: #7ee787;     /* Verde terminal */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Scroll gestionado internamente */
            display: flex;
        }

        /* =========================================
           1. SIDEBAR (Navegación Izquierda)
           ========================================= */
        .sidebar {
            width: 280px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            flex-shrink: 0;
            z-index: 10;
        }

        .profile-summary { margin-bottom: 3rem; }
        .profile-name { font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
        .profile-role { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent); margin-top: 5px; }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 5px; }
        
        /* Items de Menú Principal */
        .nav-item {
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-muted);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background-color: var(--accent-dim); color: var(--accent); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }

        /* Grupos Desplegables (Acordeón) */
        .nav-group-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-radius: 6px; cursor: pointer;
            color: var(--text-muted); font-size: 0.95rem; transition: 0.2s;
        }
        .nav-group-header:hover { color: var(--text-main); background: rgba(255,255,255,0.03); }
        .nav-group-header i.fa-chevron-down { font-size: 0.7rem; transition: transform 0.3s; }

        .nav-group.open .nav-group-header { color: var(--text-main); }
        .nav-group.open .nav-group-header i.fa-chevron-down { transform: rotate(180deg); }

        .nav-sub-menu {
            max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out;
            padding-left: 10px; border-left: 1px solid rgba(255,255,255,0.05); margin-left: 15px;
        }

        .nav-sub-item {
            padding: 8px 15px 8px 32px; font-size: 0.85rem; color: var(--text-muted);
            cursor: pointer; display: block; border-radius: 4px; transition: 0.2s;
        }
        .nav-sub-item:hover { color: var(--accent); background: rgba(47, 129, 247, 0.05); }
        .nav-sub-item.active { color: var(--accent); font-weight: 600; background: var(--accent-dim); }

        .social-links { margin-top: auto; display: flex; gap: 15px; padding-top: 20px; border-top: 1px solid var(--border); }
        .social-icon { color: var(--text-muted); font-size: 1.2rem; transition: 0.2s; }
        .social-icon:hover { color: var(--text-main); }

        /* =========================================
           2. MAIN CONTENT (Panel Derecho)
           ========================================= */
        .main-content {
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto;       /* Scroll vertical habilitado */
            overflow-x: hidden;
            padding: 3rem 4rem; 
            padding-bottom: 200px !important; /* Colchón inferior para scroll */
            position: relative;
            scroll-behavior: smooth;
        }

        /* Pestañas (Tabs) */
        .tab-content { display: none; opacity: 0; animation: fadeIn 0.4s forwards; }
        .tab-content.active-tab { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* Tipografía General */
        h2 { font-size: 2rem; margin-bottom: 1.5rem; color: #fff; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        h3 { font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-main); }
        p { color: var(--text-muted); line-height: 1.7; margin-bottom: 1rem; max-width: 800px; }
        
        .code-tag { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; background: rgba(110,118,129,0.2); padding: 2px 6px; border-radius: 4px; color: var(--text-main); }
        .tech-pill { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent); border: 1px solid var(--border); padding: 4px 10px; border-radius: 100px; }
        .tech-stack { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }

        /* Cards & Grid */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); padding: 25px; border-radius: 8px; transition: 0.2s; }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); }
        
        /* Timeline (Experience Section) */
        .timeline { margin-top: 20px; border-left: 2px solid var(--border); padding-left: 30px; }
        .timeline-item { position: relative; margin-bottom: 40px; }
        .timeline-item::before { content: ''; position: absolute; left: -36px; top: 5px; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; border: 2px solid var(--bg-body); }
        .timeline-date { font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }

        .phd-highlight { background: linear-gradient(180deg, rgba(47,129,247,0.1) 0%, rgba(0,0,0,0) 100%); border: 1px solid var(--accent); padding: 30px; border-radius: 8px; margin-bottom: 30px; }
        .library-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); align-items: baseline; }
        .book-author { font-size: 0.9rem; color: var(--text-muted); font-style: italic; }

        /* =========================================
           3. NARRATIVA & STORYTELLING (Profile Tab)
           ========================================= */
        .narrative-container {
            display: grid;
            grid-template-columns: 1fr 180px; /* Historia | Timeline Sticky */
            gap: 40px;
            position: relative;
            width: 100%;
        }

        .narrative-content { min-width: 0; } /* Previene desbordamiento en grid */

        .narrative-section {
            margin-bottom: 80px;
            padding-top: 20px;
            opacity: 0.3;               /* Efecto foco inactivo */
            transform: translateX(-10px);
            transition: all 0.6s ease;
            filter: blur(1px);
        }

        .narrative-section.active-chapter {
            opacity: 1;                 /* Efecto foco activo */
            transform: translateX(0);
            filter: blur(0);
        }

        .narrative-text { font-size: 1rem; color: var(--text-muted); line-height: 1.8; text-align: justify; }
        .narrative-text p { margin-bottom: 15px; max-width: none !important; width: 100%; }

        .inline-link {
            color: var(--accent); text-decoration: none; border-bottom: 1px dotted var(--accent);
            cursor: pointer; transition: 0.2s; font-weight: 600;
        }
        .inline-link:hover { background: rgba(47, 129, 247, 0.1); }

        /* Timeline Lateral (Sticky) */
        .timeline-sticky {
            position: sticky; top: 50px; height: fit-content; align-self: start;
            border-left: 2px solid var(--border); padding-left: 20px;
        }

        .timeline-nav-item {
            display: block; position: relative; padding: 10px 0; cursor: pointer;
            color: var(--text-muted); font-size: 0.85rem; transition: 0.3s; font-family: 'JetBrains Mono';
        }
        .timeline-nav-item::before {
            content: ''; position: absolute; left: -26px; top: 18px; width: 8px; height: 8px;
            background: var(--bg-body); border: 2px solid var(--text-muted); border-radius: 50%; transition: 0.3s;
        }
        .timeline-nav-item.active { color: #fff; transform: translateX(5px); }
        .timeline-nav-item.active::before { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* Imágenes en Narrativa (Grid interno) */
        .chapter-layout {
            display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 40px; align-items: start;
        }
        .chapter-text { text-align: justify; }
        
        .chapter-image-wrapper {
            position: relative; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border); background: rgba(255,255,255,0.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease;
        }
        .chapter-image-wrapper:hover { border-color: var(--accent); transform: translateY(-5px); }
        
        .chapter-img {
            width: 100%; height: auto; display: block; object-fit: cover;
            filter: grayscale(40%) contrast(110%); transition: 0.5s;
        }
        .chapter-layout:hover .chapter-img { filter: grayscale(0%); }

        .img-caption {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 23, 42, 0.9); color: var(--accent);
            font-family: 'JetBrains Mono'; font-size: 0.7rem; padding: 5px 10px; border-top: 1px solid var(--border);
        }

        /* Responsive Mobile */
        @media (max-width: 1100px) {
            .chapter-layout { grid-template-columns: 1fr; }
            .chapter-image-wrapper { margin-top: 20px; max-width: 100%; }
        }
        @media (max-width: 900px) {
            .timeline-sticky { display: none; }
            .narrative-container { grid-template-columns: 1fr; }
            .narrative-section { opacity: 1; transform: none; filter: none; }
        }
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border); }
            .nav-menu { flex-direction: row; overflow-x: auto; padding-bottom: 10px; }
            .nav-item { white-space: nowrap; }
            .main-content { padding: 2rem 1.5rem; overflow-y: visible; padding-bottom: 150px !important; }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="profile-summary">
            <div class="profile-name">Pablo Mora Moreno</div>
            <div class="profile-role">Electrical & Mechatronics Eng.</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                PhD Candidate @ UMA <br>
                Model-Free Control Specialist
            </div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item active" id="nav-btn-profile" onclick="switchTab('profile')">
                <i class="fas fa-user"></i> Profile
            </li>
            
            <li class="nav-group" id="group-phd">
                <div class="nav-group-header" onclick="toggleGroup('group-phd')">
                    <span style="display:flex; gap:12px; align-items:center;">
                        <i class="fas fa-atom"></i> PhD Research
                    </span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="nav-sub-menu">
                    <a class="nav-sub-item" id="nav-btn-phd" onclick="switchTab('phd')">Overview</a>
                    <a class="nav-sub-item" id="nav-btn-phd-board" onclick="loadProjectDetail('phd-board')">9-Phase Control Board</a>
                    <a class="nav-sub-item" id="nav-btn-phd-papers" onclick="loadProjectDetail('phd-papers')">Publications</a>
                </div>
            </li>

            <li class="nav-item" id="nav-btn-experience" onclick="switchTab('experience')">
                <i class="fas fa-briefcase"></i> Experience
            </li>

            <li class="nav-group" id="group-projects">
                <div class="nav-group-header" onclick="toggleGroup('group-projects')">
                    <span style="display:flex; gap:12px; align-items:center;">
                        <i class="fas fa-code-branch"></i> Projects
                    </span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="nav-sub-menu">
                    <a class="nav-sub-item" id="nav-btn-projects" onclick="switchTab('projects')">All Projects</a>
                    <a class="nav-sub-item" id="nav-btn-proj-48v" onclick="loadProjectDetail('proj-48v')">48V Electric Drive</a>
                    <a class="nav-sub-item" id="nav-btn-proj-rover" onclick="loadProjectDetail('proj-rover')">WiFi Rover</a>
                    <a class="nav-sub-item" id="nav-btn-proj-servo" onclick="loadProjectDetail('proj-servo')">Servo Drive (Robotics)</a>
                    <a class="nav-sub-item" id="nav-btn-proj-fault" onclick="loadProjectDetail('proj-fault')">Fault Detection</a>
                </div>
            </li>

            <li class="nav-item" id="nav-btn-library" onclick="switchTab('library')">
                <i class="fas fa-book"></i> Library & Ed.
            </li>
        </ul>

        <div class="social-links">
            <a href="https://www.linkedin.com/in/pablo-mora-moreno-0b7642227" target="_blank" class="social-icon"><i class="fab fa-linkedin"></i></a>
            <a href="mailto:pmoram.w@gmail.com" class="social-icon"><i class="fas fa-envelope"></i></a>
            <a href="https://github.com/PMORAM-20" target="_blank" class="social-icon"><i class="fab fa-github"></i></a>
        </div>
    </aside>

    <main class="main-content">
        <div id="tab-profile" class="tab-content active-tab">
            </div>

        <div id="tab-phd" class="tab-content">
            <h2>PhD Research</h2>
            <div class="phd-highlight">
                <h3 style="color: var(--accent);">Model-Free Predictive Control for Multiphase Machines</h3>
                <p>
                    Developing a novel control scheme based on gradient analysis of electric variables. 
                    This approach removes parameter dependency, improves dynamic performance, and reduces computational burden compared to traditional MPC.
                </p>
            </div>

            <div class="card-grid">
                <div class="card">
                    <h3><i class="fas fa-vial"></i> Experimental Validation</h3>
                    <p>Implementation of control strategies on a real test bed. Validation of back-EMF compensation techniques and adaptable modulation to avoid parameter usage.</p>
                </div>
                <div class="card">
                    <h3><i class="fas fa-server"></i> 9-Phase Control Board</h3>
                    <p>Design of a custom modular control board featuring:</p>
                    <ul style="list-style: none; color: var(--text-muted); font-size: 0.9rem; margin-top: 10px;">
                        <li>• <span class="code-tag">0.04%</span> Accuracy in voltage/current measurement.</li>
                        <li>• <strong>CAN FD</strong> communication (5 Mbps).</li>
                        <li>• Sigma-delta modulation for DC-link monitoring.</li>
                        <li>• FPGA/DSP integration for real-time processing.</li>
                    </ul>
                </div>
                <div class="card">
                    <h3><i class="fas fa-chart-line"></i> Scientific Contribution</h3>
                    <p>Presented at <strong>14th EDPC (Sept 2024)</strong>. Researching non-linear effects impact on control schemes to optimize designs during conceptualization.</p>
                </div>
            </div>
        </div>

        <div id="tab-experience" class="tab-content">
            <h2>Professional Experience</h2>
            <div class="timeline" id="experience-list"></div>
        </div>

        <div id="tab-projects" class="tab-content">
            <h2>Engineering Projects</h2>
            <p>A mix of self-taught initiatives, academic requirements, and competitive team developments.</p>
            <div class="card-grid" id="projects-list"></div>
        </div>

        <div id="tab-library" class="tab-content">
            <h2>Education</h2>
            <div style="margin-bottom: 3rem;">
                <div style="margin-bottom: 20px;">
                    <h3 style="display:flex; justify-content:space-between;">
                        Master's in Mechatronic Engineering
                        <span class="code-tag">GPA 9.0/10</span>
                    </h3>
                    <p style="margin-bottom: 0;">University of Málaga (2023-2024)</p>
                    <p style="font-size: 0.9rem;"><em>Awarded Best Academic Record Prize for the Thesis.</em></p>
                </div>
                <div>
                    <h3 style="display:flex; justify-content:space-between;">
                        Bachelor's in Electrical Engineering
                        <span class="code-tag">GPA 8.9/10</span>
                    </h3>
                    <p>University of Málaga (2019-2023)</p>
                </div>
            </div>

            <h2>The Library</h2>
            <p>Curated list of technical literature and papers that form the basis of my knowledge.</p>
            <div id="library-list" style="margin-top: 20px;"></div>
        </div>
    </main>

    <script>
        // --- 1. DATOS: HISTORIA DETALLADA (Narrative Story) ---
        const narrativeData = [
            {
                id: "chapter-intro",
                title: "Introduction & Vision",
                image: "assets/img/pmm_provisional.png", 
                caption: "Fixing some hardware issues in the lab...", 
                year: "About Me",
                content: `
                    <p>I am Pablo Mora Moreno, an innovative Electrical Engineer with a Master's in Mechatronics and an ongoing PhD in <span class="code-font">model-free predictive control</span> for multiphase electric machines. My passion lies in advancing power electronics, electric drives, vehicles, and embedded systems. With hands-on experience in research, industry, and personal projects, I bring a blend of academic excellence and practical skills to multidisciplinary teams.</p>
                    <p>I am eager to contribute to Europe's dynamic tech ecosystem, where innovation in sustainable mobility and electrification is thriving. My expertise focuses on developing robust, parameter-independent control strategies that enhance efficiency in electric propulsion systems.</p>`
            },
            {
                id: "chapter-origin",
                title: "The Origin",
                image: "assets/img/citroneta_cad.jpg", // <--- PON TU FOTO AQUÍ
                caption: "Citroneta Project: Servo-actuation System",
                year: "2018 - 2020",
                content: `
                    <p>My journey in engineering began in 2018 studying Mechanical Engineering at the University of Málaga. From the outset, I was drawn to systems design and dynamics. In my second year, I switched to a double degree in Mechanical and Automotive Engineering at the University of Nebrija in Madrid.</p>
                    <p>There, I delved into vehicle dynamics and advanced 3D design using CATIA. A highlight was my contribution to the <strong>Citroneta project</strong>, where I designed a servo-actuation system incorporating a Haldex clutch to optimize the drivetrain. This taught me the value of mechanical integration but highlighted the need for a stronger electrical foundation.</p>`
            },
            {
                id: "chapter-bachelor",
                title: "Electrical Foundations",
                year: "2020 - 2023",
                image: "assets/img/lab_optimization.jpg", // <--- PON TU FOTO AQUÍ
                caption: "Optimizing Multiphase Parameters (Python)",
                content: `
                    <p>I returned to UMA to pursue my Bachelor's in Electrical Engineering, graduating with a <strong>GPA of 8.9/10</strong>. My Bachelor's thesis (TFG) focused on developing optimization tools using metaheuristic techniques in Python to estimate parameters of multiphase machines from experimental data.</p>
                    <p>During this time, I joined the electric drives laboratory, immersing myself for nearly 4 years in multiphase machines and power converters up to 1000V. These experiences directly informed my thesis and set the stage for my <a class="inline-link" onclick="switchTab('phd')">current research</a>.</p>`
            },
            {
                id: "chapter-formula",
                title: "Formula Student Era",
                year: "2020 - 2024",
                image: "assets/img/mart_car.jpg", // <--- PON TU FOTO AQUÍ
                caption: "MART Málaga Racing Car (600V System)",
                content: `
                    <p>Professionally, my path accelerated when I joined the <strong>MART Málaga Formula Student team</strong> as an E-Powertrain Engineer. Over four years, I evolved powertrains from combustion analysis to a <a class="inline-link" onclick="switchTab('projects')">600V battery-powered 3-phase propulsion system</a>.</p>
                    <p>I programmed control algorithms in C on TI microcontrollers and integrated CAN, I2C, and SPI protocols for hard-real-time control. I also defined actuation protocols for critical scenarios like over-current or wheel slipping.</p>`
            },
            {
                id: "chapter-pro",
                title: "Industry & Master's",
                year: "2023 - 2024",
                image: "assets/img/evo.jpg", // <--- PON TU FOTO AQUÍ
                caption: "Evolution Synergetique's H2TT Vehicle",
                content: `
                    <p>I worked at <strong>Evolution Synergetique (EVO)</strong> in Seville as a Systems Engineering Automotive specialist. There, I developed control algorithms in MATLAB/Simulink for fuel cell hybrid electric vehicle powertrains, complying with <strong>Automotive SPICE</strong> regulations.</p>
                    <p>Simultaneously, I completed my <a class="inline-link" onclick="switchTab('library')">Master's in Mechatronic Engineering</a> (GPA 9.0/10). My thesis introduced a novel gradient-based model-free control scheme, validated experimentally, which earned me the Best Academic Record Prize.</p>`
            },
            {
                id: "chapter-phd",
                title: "PhD & Research",
                image: "assets/img/phd_test_bed.jpg", // <--- PON TU FOTO AQUÍ
                caption: "ACETI group nine-phase test bed",
                year: "Present",
                content: `
                    <p>Since September 2024, I have been pursuing my PhD, focusing on <a class="inline-link" onclick="switchTab('phd')">model-free predictive controls</a> for multiphase machines. Innovations include gradient-based voltage vector selection and back-EMF compensation.</p>
                    <p>To enable experimental testing, I am finalizing a modular <strong>9-phase control board</strong> featuring 0.04% measurement accuracy, CAN FD, and FPGA integration. This work was presented at the 14th EDPC conference.</p>`
            }
        ];

        // --- 2. REST OF DATA ---
        const experienceData = [
            { role: "Research Engineer in Electrical Drives", company: "University of Málaga", date: "Jan 2024 - Present", desc: "Implemented embedded control algorithms on TI microcontrollers (C/C++) and estimated dynamic parameters using MATLAB/Python. Setting up a 9-phase electric drive test bed." },
            { role: "Systems Engineering Automotive", company: "EVO Seville", date: "Mar 2023 - Jan 2024", desc: "Developed/Simulated control algorithms (Simulink) for fuel cell hybrid electric vehicle powertrains in compliance with Automotive SPICE regulations. Optimized balance between battery capacity, fuel cell, and cooling systems." },
            { role: "E-Powertrain Engineer", company: "MART Málaga (Formula Student)", date: "Sept 2020 - Sept 2024", desc: "Developed powertrain for race cars. Designed 600V battery-powered 3-phase propulsion system. Programmed control algorithms in C for TI MCUs involving CAN, I2C, and SPI protocols." },
            { role: "Calibration Test Engineer", company: "University of Málaga", date: "Jul 2025 - Aug 2025", desc: "Designed test bench to calibrate LC filters for railway substations. Automated frequency profiles to obtain experimental Bode diagrams." }
        ];

        const projectsData = [
            { title: "48V Electric Drive", type: "Personal Project", tags: ["GaN", "C/C++", "MPC"], desc: "Self-taught development of a 48V battery-powered 3-phase drive. Features sensorless MPC with Maximum Torque Per Ampere (MTPA) and Field Weakening, running on TI MCU." },
            { title: "High-Performance Servo Drive", type: "Ongoing", tags: ["STM32", "Robotics", "Hardware"], desc: "6kW PMSM system with GaN converter and custom battery. Controlled by STM32, designed for high precision and power density in robotic articulations (125 cm³ package)." },
            { title: "WiFi-Controlled Rover", type: "Personal Project", tags: ["IoT", "MATLAB", "Arduino"], desc: "Rover controlled via WiFi/BLE using MATLAB/Simulink. Supports over-the-air code loading and system monitoring." },
            { title: "Fault Detection Algorithms", type: "Research Scholarship", tags: ["Signal Processing", "Python"], desc: "Developed simulation-based techniques (Wavelet, Stockwell transforms) to detect faults in multiphase electric drives." }
        ];

        const libraryData = [
            { title: "Electric Machinery Fundamentals", author: "Chapman" },
            { title: "Model Predictive Control", author: "Camacho & Bordons" },
            { title: "Vehicle Dynamics", author: "Gillespie" },
            { title: "Power Electronics: Converters, Applications, and Design", author: "Mohan / Undeland" },
            { title: "Modern Power Electronics and AC Drives", author: "B.K. Bose" },
        ];

        // --- 3. FUNCIONES DE RENDERIZADO ---

        function renderProfile() {
            const container = document.getElementById('tab-profile');
            let narrativeHTML = narrativeData.map(chapter => {
                let imageHTML = '';
                if (chapter.image) {
                    imageHTML = `
                        <div class="chapter-image-wrapper">
                            <img src="${chapter.image}" class="chapter-img" alt="${chapter.title}">
                            <div class="img-caption">${chapter.caption || ''}</div>
                        </div>
                    `;
                }
                return `
                <div id="${chapter.id}" class="narrative-section">
                    <h2 style="border:none; margin-bottom:10px; color:var(--text-main); font-size:1.6rem;">${chapter.title}</h2>
                    <div class="code-font" style="color:var(--accent); margin-bottom:20px;">${chapter.year}</div>
                    <div class="${chapter.image ? 'chapter-layout' : ''}">
                        <div class="chapter-text">${chapter.content}</div>
                        ${imageHTML}
                    </div>
                </div>`;
            }).join('');

            let timelineHTML = narrativeData.map(chapter => `
                <a class="timeline-nav-item" onclick="scrollToChapter('${chapter.id}')" id="nav-${chapter.id}">
                    ${chapter.title}
                    <div style="font-size:0.7em; opacity:0.6;">${chapter.year}</div>
                </a>
            `).join('');

            container.innerHTML = `
                <div class="narrative-container">
                    <div class="narrative-content">
                        <div style="margin-bottom:40px; border-bottom:1px solid var(--border); padding-bottom:20px;">
                            <h1 style="font-size:2.5rem;">Pablo Mora Moreno</h1>
                            <p class="code-font" style="color:var(--text-muted);">> PhD Candidate & Mechatronics Engineer</p>
                        </div>
                        ${narrativeHTML}
                    </div>
                    <aside class="timeline-sticky">
                        <div style="margin-bottom:20px; font-weight:700; color:#fff;">TIMELINE</div>
                        ${timelineHTML}
                    </aside>
                </div>
            `;
            initScrollSpy();
        }

        function renderContent() {
            // Experience
            const expContainer = document.getElementById('experience-list');
            experienceData.forEach(item => {
                expContainer.innerHTML += `
                <div class="timeline-item">
                    <div class="timeline-date">${item.date}</div>
                    <h3>${item.role} <span style="font-size:0.9rem; color:var(--accent); font-weight:400;">@ ${item.company}</span></h3>
                    <p>${item.desc}</p>
                </div>`;
            });
            // Projects
            const projContainer = document.getElementById('projects-list');
            projectsData.forEach(item => {
                let tagsHTML = item.tags.map(t => `<span class="tech-pill">${t}</span>`).join('');
                projContainer.innerHTML += `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h3>${item.title}</h3>
                        <span class="code-tag">${item.type}</span>
                    </div>
                    <div class="tech-stack">${tagsHTML}</div>
                    <p style="font-size: 0.9rem; margin-top: 10px;">${item.desc}</p>
                </div>`;
            });
            // Library
            const libContainer = document.getElementById('library-list');
            libraryData.forEach(item => {
                libContainer.innerHTML += `
                <div class="library-item">
                    <span style="font-weight: 600; color: var(--text-main);">${item.title}</span>
                    <span class="book-author">${item.author}</span>
                </div>`;
            });
        }

        // --- 4. LÓGICA DE NAVEGACIÓN (Sidebar & Tabs) ---

        function toggleGroup(groupId) {
            const group = document.getElementById(groupId);
            const subMenu = group.querySelector('.nav-sub-menu');
            group.classList.toggle('open');
            if (group.classList.contains('open')) {
                subMenu.style.maxHeight = subMenu.scrollHeight + "px";
            } else {
                subMenu.style.maxHeight = "0";
            }
        }

        function switchTab(tabId) {
            // A. Cambiar Pestaña
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active-tab'));
            const targetContent = document.getElementById('tab-' + tabId);
            if(targetContent) {
                targetContent.classList.add('active-tab');
                document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
            }

            // B. Sincronizar Sidebar
            document.querySelectorAll('.nav-item, .nav-sub-item').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById('nav-btn-' + tabId);
            if (activeBtn) {
                activeBtn.classList.add('active');
                // Auto-expandir si está dentro de un grupo
                const parentGroup = activeBtn.closest('.nav-group');
                if (parentGroup && !parentGroup.classList.contains('open')) {
                    toggleGroup(parentGroup.id);
                }
            }
        }

        function loadProjectDetail(projId) {
            // Fallback temporal hasta tener vistas de detalle
            if(projId.includes('phd')) switchTab('phd'); 
            else switchTab('projects');

            // Forzamos el highlight del botón específico
            document.querySelectorAll('.nav-item, .nav-sub-item').forEach(el => el.classList.remove('active'));
            const specificBtn = document.getElementById('nav-btn-' + projId);
            if(specificBtn) specificBtn.classList.add('active');
        }

        // --- 5. SCROLLSPY (Narrative Sync) ---

        function scrollToChapter(id) {
            const element = document.getElementById(id);
            if(element) {
                const main = document.querySelector('.main-content');
                main.scrollTo({ top: element.offsetTop - 40, behavior: 'smooth' });
            }
        }

        function initScrollSpy() {
            const observerOptions = {
                root: document.querySelector('.main-content'),
                rootMargin: '-40% 0px -50% 0px', // Zona de activación en el centro visual
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Activar texto
                        document.querySelectorAll('.narrative-section').forEach(s => s.classList.remove('active-chapter'));
                        entry.target.classList.add('active-chapter');
                        // Activar timeline
                        document.querySelectorAll('.timeline-nav-item').forEach(t => t.classList.remove('active'));
                        const navItem = document.getElementById(`nav-${entry.target.id}`);
                        if(navItem) navItem.classList.add('active');
                    }
                });
            }, observerOptions);

            narrativeData.forEach(chapter => {
                const el = document.getElementById(chapter.id);
                if(el) observer.observe(el);
            });
        }

        // Ejecutar al inicio
        renderProfile();
        renderContent();
    </script>
</body>
</html>